<!-- Ë∞∑Ê≠åÂú∞ÂõæÈÄâÊã©Ôºå‰ΩøÁî®web-viewÂÜÖÂµåÊòæÁ§∫ -->
<!DOCTYPE html>
<!-- uni ÁöÑ SDK -->
<script type="text/javascript" src="./uni.webview.1.5.6.js"></script>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<title>Ë∞∑Ê≠åÂú∞ÂõæÊêúÁ¥¢</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body,
			html {
				height: 100%;
				font-family: Arial, sans-serif;
			}

			.container {
				height: 100%;
				display: flex;
				flex-direction: column;
			}

			.header {
				background: #fff;
				padding: 10px;
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
				z-index: 100;
				padding-top: 50px;
				display: none;
			}

			.search-container {
				display: flex;
				align-items: center;
				margin-bottom: 10px;
			}
			.search-back {
				font-size: 20px;
				padding-right: 10px;
			}
			.search-input {
				flex: 1;
				padding: 10px;
				border: 1px solid #ddd;
				border-radius: 4px 0 0 4px;
				font-size: 14px;
			}

			.search-btn {
				padding: 10px 15px;
				background: #4285f4;
				color: white;
				border: none;
				border-radius: 0 4px 4px 0;
				cursor: pointer;
			}

			.tabs {
				display: flex;
				border-bottom: 1px solid #eee;
			}

			.tab {
				flex: 1;
				text-align: center;
				padding: 10px;
				cursor: pointer;
				background: #f5f5f5;
			}

			.tab.active {
				background: #4285f4;
				color: white;
			}

			.map-container {
				flex: 1;
				position: relative;
			}

			#map {
				width: 100%;
				height: 100%;
			}

			.results-panel {
				/* position: absolute;
				top: 10px;
				left: 1vw;
				width: 98vw; */
				height: 40vh;
				background: white;
				border-radius: 4px;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
				z-index: 99;
				overflow-y: auto;
				display: none;
			}

			.result-item {
				padding: 15px;
				border-bottom: 1px solid #eee;
				cursor: pointer;
			}

			.result-item:hover {
				background: #f5f5f5;
			}

			.result-name {
				font-weight: bold;
				margin-bottom: 5px;
			}

			.result-address {
				font-size: 12px;
				color: #666;
				margin-bottom: 5px;
			}

			.result-rating {
				font-size: 12px;
				color: #f57c00;
			}

			.close-btn {
				padding: 5px;
				position: absolute;
				top: 5px;
				right: 5px;
				background: none;
				border: none;
				font-size: 18px;
				cursor: pointer;
			}

			.current-location-btn {
				position: absolute;
				bottom: 25px;
				right: 10px;
				background: white;
				border: 1px solid #ccc;
				border-radius: 4px;
				padding: 10px;
				cursor: pointer;
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
				z-index: 99;
			}

			.loading {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				background: rgba(0, 0, 0, 0.7);
				color: white;
				padding: 10px 20px;
				border-radius: 4px;
				z-index: 100;
				display: none;
			}
			
			.route-info {
				position: relative;
			}
			.route-summary {
				/* position: absolute;
				left: 0;
				top: 0; */
				font-size: 14px;
				color: #000;
				padding: 2px 10px;
				border-radius: 20px;
				background: #fff;
				font-weight: 400;
			}
			
			/* Ëá™ÂÆö‰πâMarker labelÊ†∑Âºè */
			.custom-marker-label {
			  background-color: #fff;
			  border-radius: 20px;
			  padding: 4px 8px;
			  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
				margin: -10px 0 0 80px;
			}
			
		</style>
	</head>
	<body>
		<div class="container">
			<div class="header" id="header">
				<div class="search-container">
					<div id="searchBack" class="search-back"><</div>
					<input type="text" id="searchInput" class="search-input" placeholder="ÊêúÁ¥¢Âú∞ÁÇπ...">
					<button id="searchBtn" class="search-btn">ÊêúÁ¥¢</button>
				</div>
				<!-- <div class="tabs">
					<div class="tab active" data-type="nearby">ÈôÑËøëÊêúÁ¥¢</div>
					<div class="tab" data-type="text">ÊñáÊú¨ÊêúÁ¥¢</div>
				</div> -->
			</div>

			<div class="map-container">
				<div id="map"></div>
				<div class="loading" id="loading">ÊêúÁ¥¢‰∏≠...</div>
				<button class="current-location-btn" id="currentLocationBtn">üìç</button>

			</div>
			<div class="results-panel" id="resultsPanel">
				<button class="close-btn" id="closeResults">√ó</button>
				<div id="resultsList"></div>
			</div>
		</div>

		<script>
			let map, placesManager, directionsManager, directionsRenderer, currentLocation, markers = [], mapTypeLibraries;
			// ÁªàÁÇπÁªèÁ∫¨Â∫¶
			let destinationObj = {}
			// ÂàùÂßãÂåñÂú∞Âõæ
			function initMap() {
				map = new google.maps.Map(document.getElementById('map'), {
					center: {
						lat: 39.9042,
						lng: 116.4074
					},
					zoom: 15,
					// Ë°óÊôØÂ∞è‰∫∫Êéß‰ª∂
					streetViewControl: false,
					// Âú∞ÂõæÁ±ªÂûãÊéß‰ª∂
					mapTypeControl: false,
					// ÂÖ®Â±èÊ®°ÂºèÊâìÂºÄÂú∞ÂõæÁöÑÊéß‰ª∂
					fullscreenControl: false,
				});
				placesManager = new google.maps.places.PlacesService(map);
				sendMessageToApp({
					action: 'loading'
				})
				// Ëé∑ÂèñÂΩìÂâç‰ΩçÁΩÆ
				getCurrentLocation();
				// ÁªëÂÆö‰∫ã‰ª∂
				bindEvents();
				// ÊêúÁ¥¢
				if (mapTypeLibraries === 'places') {
					document.getElementById('header').style.display = 'block';
				}
				
				
				// directionsManager = new google.maps.DirectionsService();
				// directionsRenderer = new google.maps.DirectionsRenderer({
				// 	map: map,
				// 	suppressMarkers: false,
				// 	polylineOptions: {
				// 		strokeColor: '#0066CC',
				// 		strokeWeight: 5
				// 	}
				// })
				if (mapTypeLibraries === 'directions') {
					// Ë∑ØÁ®ãËßÑÂàí
					// directionsManager = new google.maps.directions.DirectionsService(map);
					// directionsRenderer = new google.maps.directions.DirectionsRenderer({
					// 	map: map,
					// 	suppressMarkers: false,
					// 	polylineOptions: {
					// 		strokeColor: '#0066CC',
					// 		strokeWeight: 5
					// 	}
					// })
					// setTimeout(function() {
					// 	planRoute()
					// },2000)
				}
				
			}

			// ÁªëÂÆö‰∫ã‰ª∂
			function bindEvents() {
				document.getElementById('searchBack').addEventListener('click', onSearchBack);
				document.getElementById('searchBtn').addEventListener('click', performSearch);
				document.getElementById('searchInput').addEventListener('keypress', function(e) {
					if (e.key === 'Enter') {
						performSearch();
					}
				});

				document.getElementById('currentLocationBtn').addEventListener('click', getCurrentLocation);
				document.getElementById('closeResults').addEventListener('click', function() {
					document.getElementById('resultsPanel').style.display = 'none';
				});

				// Ê†áÁ≠æÂàáÊç¢
				document.querySelectorAll('.tab').forEach(tab => {
					tab.addEventListener('click', function() {
						document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
						this.classList.add('active');
					});
				});
			}

			// Ëé∑ÂèñÂΩìÂâç‰ΩçÁΩÆ
			function getCurrentLocation() {
				showLoading(true);

				if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(
						position => {
							currentLocation = {
								lat: position.coords.latitude,
								lng: position.coords.longitude
							};
							let label = {}
							if (mapTypeLibraries === 'directions') {
								let contLocation = calculateCenterPoint(currentLocation.lat, currentLocation.lng,destinationObj.lat,destinationObj.lng)
								map.setCenter(contLocation);
								label = {
									text: 'Ëµ∑ÁÇπ',
									color: '#000',
									fontSize: '14px',
									className: 'custom-marker-label'
								}
								// ÁªàÁÇπ
								const destination = new google.maps.Marker({
									position: destinationObj,
									map: map,
									title: 'ÁªàÁÇπ',
									icon: '../imgs/group-from.png',
									label: {
										text: 'ÁªàÁÇπ',
										color: '#000',
										fontSize: '14px',
										className: 'custom-marker-label'
									}
								});
								
								// Áõ¥Á∫øË∑ØÁ∫ø
								drawRouteLine(currentLocation, destinationObj)
							} else {
								map.setCenter(currentLocation);
							}
							
							// Ê∑ªÂä†ÂΩìÂâç‰ΩçÁΩÆÊ†áËÆ∞
							const marker = new google.maps.Marker({
								position: currentLocation,
								map: map,
								title: 'ÂΩìÂâç‰ΩçÁΩÆ',
								icon: '../imgs/group-go.png',
								label,
							});

							showLoading(false);
							
							if (mapTypeLibraries === 'places') {
								// Â¶ÇÊûúËæìÂÖ•Ê°Ü‰∏∫Á©∫ÔºåËá™Âä®ÊêúÁ¥¢ÈôÑËøëÁöÑÂú∞ÁÇπ
								if (!document.getElementById('searchInput').value.trim()) {
									searchNearbyPlaces('');
								}
							}
							
						},
						error => {
							console.error('Ëé∑Âèñ‰ΩçÁΩÆÂ§±Ë¥•:', error);
							showLoading(false);
						}
					);
				} else {
					showLoading(false);
				}
			}
			
			// ËøîÂõû‰∏ä‰∏ÄÈ°µ
			function onSearchBack() {
				uni.navigateBack()
			}

			// ÊâßË°åÊêúÁ¥¢
			function performSearch() {
				const query = document.getElementById('searchInput').value.trim();
				// const searchType = document.querySelector('.tab.active').dataset.type;

				if (!query) {
					alert('ËØ∑ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆËØç');
					return;
				}

				// if (searchType === 'nearby') {
				// 	searchNearbyPlaces(query);
				// } else {
				// 	searchTextPlaces(query);
				// }
				searchTextPlaces(query);
			}

			// ÈôÑËøëÊêúÁ¥¢
			function searchNearbyPlaces(keyword) {
				if (!currentLocation) {
					alert('ËØ∑ÂÖàËé∑ÂèñÂΩìÂâç‰ΩçÁΩÆ');
					return;
				}

				showLoading(true);

				const request = {
					location: currentLocation,
					radius: 1000, // 1ÂÖ¨ÈáåËåÉÂõ¥
					keyword: keyword,
					types: ['restaurant'],
				};

				placesManager.nearbySearch(request, (results, status) => {
					showLoading(false);

					if (status === google.maps.places.PlacesServiceStatus.OK) {
						displayResults(results);
						displayPlacesOnMap(results);
					} else {
						alert('ÊêúÁ¥¢Â§±Ë¥•: ' + status);
					}
				});
			}

			// ÊñáÊú¨ÊêúÁ¥¢
			function searchTextPlaces(query) {
				showLoading(true);

				const request = {
					query: query,
					...(currentLocation ? {
						location: currentLocation,
						radius: 5000
					} : {})
				};

				placesManager.textSearch(request, (results, status) => {
					showLoading(false);

					if (status === google.maps.places.PlacesServiceStatus.OK) {
						displayResults(results, query);
						displayPlacesOnMap(results);
					} else {
						alert('ÊêúÁ¥¢Â§±Ë¥•: ' + status);
					}
				});
			}

			// ÊòæÁ§∫ÊêúÁ¥¢ÁªìÊûú
			function displayResults(results, query) {
				const resultsList = document.getElementById('resultsList');
				resultsList.innerHTML = '';
				
				// ‰∏≠ÂøÉÁÇπ
				if (query) {
					map.setCenter(results[0].geometry.location);
					map.setZoom(17);
				}
				
				
				let nearbyList = results.map(item => {
					
					const distance = calculateHaversineDistance(
							currentLocation.lat,
							currentLocation.lng,
							item.geometry.location.lat(),
							item.geometry.location.lng()
					);
					return {
						...item,
						distance,
						address: item.vicinity,
						lat: item.geometry.location.lat(),
						lng: item.geometry.location.lng(),
					};
				}).sort((a, b) => a.distance - b.distance)
				nearbyList = nearbyList.map(item => {
					return {
						...item,
						distance: item.distance > 1 ? `${item.distance.toFixed(2)}km` : item.distance ? `${parseInt(item.distance*1000)}m` : '',
					}
				})

				nearbyList.forEach((place, index) => {
					const item = document.createElement('div');
					item.className = 'result-item';
					item.innerHTML = `
                    <div class="result-name">${place.name}</div>
                    <div class="result-address">${place.vicinity || place.formatted_address || ''}</div>
                    <div class="result-rating">
                        Ë∑ùÁ¶ª: ${place.distance} 
                        
                    </div>
                `;

					item.addEventListener('click', () => {
						console.log('ËØ¶ÊÉÖ‰ø°ÊÅØ', place)
						// ÁÇπÂáªÁªìÊûúÈ°πÔºåÂú®Âú∞Âõæ‰∏äÂ±Ö‰∏≠ÊòæÁ§∫
						if (place.geometry && place.geometry.location) {
							map.setCenter(place.geometry.location);
							map.setZoom(17);
							sendMessageToApp({
								action: 'info',
								info: place
							})
						}
					});

					resultsList.appendChild(item);
				});

				document.getElementById('resultsPanel').style.display = 'block';
			}

			// Âú®Âú∞Âõæ‰∏äÊòæÁ§∫Âú∞ÁÇπ
			function displayPlacesOnMap(places) {
				// Ê∏ÖÈô§‰πãÂâçÊ†áËÆ∞
				clearMarkers();

				places.forEach(place => {
					if (!place.geometry || !place.geometry.location) return;

					const marker = new google.maps.Marker({
						position: place.geometry.location,
						map: map,
						title: place.name,
						icon: '../imgs/group-from.png',
					});

					// Ê∑ªÂä†‰ø°ÊÅØÁ™óÂè£
					const infoWindow = new google.maps.InfoWindow({
						headerContent: `${place.name}`,
						content: `<div>
												<p style="margin: 0 0 5px 0; font-size: 12px;">${place.vicinity || place.formatted_address || ''}</p>
												<p style="margin: 0; font-size: 12px;">ËØÑÂàÜ: ${place.rating || 'ÊöÇÊó†'} (${place.user_ratings_total || 0}Êù°ËØÑËÆ∫)</p>
										</div>`
					});

					marker.addListener('click', () => {
						infoWindow.open(map, marker);
					});

					markers.push(marker);
				});
			}

			// Ê∏ÖÈô§Ê†áËÆ∞
			function clearMarkers() {
				markers.forEach(marker => marker.setMap(null));
				markers = [];
			}

			// ÊòæÁ§∫/ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
			function showLoading(show) {
				document.getElementById('loading').style.display = show ? 'block' : 'none';
			}

			// ‰ªéAPPÊé•Êî∂APIÂØÜÈí•
			function setApiKey(apiKey, language, region, libraries, destination) {
				mapTypeLibraries = libraries
				destinationObj = destination || {}
				if (apiKey) {
					window.GOOGLE_MAPS_API_KEY = apiKey;
					// ÈáçÊñ∞Âä†ËΩΩÂú∞ÂõæAPI
					const script = document.createElement('script');
					script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initMap&language=${language}&region=${region}`;
					script.async = true;
					script.defer = true;
					document.head.appendChild(script);
				}
			}

			// Êé•Êî∂Êù•Ëá™APPÁöÑÊ∂àÊÅØ
			window.addEventListener('message', function(event) {
				console.log('Êé•Êî∂Êù•Ëá™APPÁöÑÊ∂àÊÅØ')
				const data = event.data;
				if (data.action === 'setApiKey') {
					setApiKey(data.apiKey);
				} else if (data.action === 'search') {
					document.getElementById('searchInput').value = data.query || '';
					performSearch();
				} else if (data.action === 'setLocation') {
					currentLocation = {
						lat: data.lat,
						lng: data.lng
					};
					map.setCenter(currentLocation);
				}
			});

			// htmlÂèëÈÄÅÁªôweb-view
			function sendMessageToApp(data) {
				try {
					// #ifdef H5
					if (window.MapIsH5) {
						window.documentPictureInPicture.setGoogleInfo(data)
						return true;
					}
					
					// #endif
					// ÊñπÊ≥ï1: ‰ΩøÁî®uni.postMessage (Êé®Ëçê)
					if (typeof uni !== 'undefined') {
						uni.postMessage({
							data: data
						});
						
						return true;
					}

					// ÊñπÊ≥ï2: ‰ΩøÁî®postMessage (ÂÖºÂÆπÊóßÁâàÊú¨)
					if (window.parent && window.parent !== window) {
						window.parent.postMessage(data, '*');
						return true;
					}

					// ÊñπÊ≥ï3: ‰ΩøÁî®AndroidÁâπÂÆöÊé•Âè£
					if (window.Android && typeof window.Android.postMessage === 'function') {
						window.Android.postMessage(JSON.stringify(data));
						return true;
					}

					return false;
				} catch (error) {
					return false;
				}
			}
			
			
			
			// ËßÑÂàíË∑ØÁ∫ø
			function planRoute() {
				// if (!this.origin || !this.destination) {
				// 	uni.showToast({
				// 		title: 'ËØ∑ËæìÂÖ•Ëµ∑ÁÇπÂíåÁªàÁÇπ',
				// 		icon: 'none'
				// 	})
				// 	return
				// }
				
				const request = {
					origin: 'ÂÖ´ÊúàËä±',
					destination: 'Áè†Ê±üÈÖíÂÆ∂',
					// waypoints: [],
					travelMode: google.maps.TravelMode.DRIVING,
					optimizeWaypoints: true
				}
				
				directionsService.route(request, (result, status) => {
					if (status === 'OK') {
						directionsRenderer.setDirections(result)
						displayRouteInfo(result)
					} else {
						// uni.showToast({
						// 	title: 'Ë∑ØÁ∫øËßÑÂàíÂ§±Ë¥•: ' + status,
						// 	icon: 'none'
						// })
						console.log('Â§±Ë¥•')
					}
				})
			}
			
			// ÊòæÁ§∫Ë∑ØÁ∫ø‰ø°ÊÅØ
			function displayRouteInfo(result) {
				const route = result.routes[0]
				const summaryPanel = document.createElement('div')
				summaryPanel.className = 'route-info'
				
				// ËÆ°ÁÆóÊÄªË∑ùÁ¶ªÂíåÊó∂Èó¥
				let totalDistance = 0
				let totalDuration = 0
				
				for (let i = 0; i < route.legs.length; i++) {
					totalDistance += route.legs[i].distance.value
					totalDuration += route.legs[i].duration.value
				}
				
				const distanceInKm = (totalDistance / 1000).toFixed(2)
				const durationInMin = Math.round(totalDuration / 60)
				
				summaryPanel.innerHTML = `
					<div class="route-summary">
						<h3>Ë°åÁ®ã‰ø°ÊÅØ</h3>
						<p>ÊÄªË∑ùÁ¶ª: ${distanceInKm} ÂÖ¨Èáå</p>
						<p>È¢ÑËÆ°Êó∂Èó¥: ${durationInMin} ÂàÜÈíü</p>
					</div>
				`
				
				// Â∞Ü‰ø°ÊÅØÈù¢ÊùøÊ∑ªÂä†Âà∞Âú∞Âõæ‰∏ä
				map.controls[google.maps.ControlPosition.TOP_CENTER].push(summaryPanel)
			}
			
			// ÁªòÂà∂‰∏§ÁÇπ‰πãÈó¥ÁöÑË∑ØÁ∫øÁ∫ø
			function drawRouteLine(start, end) {
				const routePath = new google.maps.Polyline({
					path: [start, end],
					geodesic: true,
					strokeColor: '#FF0000',
					strokeOpacity: 1.0,
					strokeWeight: 2
				});
				
				routePath.setMap(map);
			}
			
			// ËÆ°ÁÆóË∑ùÁ¶ª
			function calculateHaversineDistance(lat1, lon1, lat2, lon2) {
					const R = 6371; // Âú∞ÁêÉÂçäÂæÑÔºåÂçï‰ΩçÔºöÂçÉÁ±≥
					const dLat = (lat2 - lat1) * (Math.PI / 180);
					const dLon = (lon2 - lon1) * (Math.PI / 180);
					const a =
							Math.sin(dLat / 2) * Math.sin(dLat / 2) +
							Math.cos(lat1 * (Math.PI / 180)) *
							Math.cos(lat2 * (Math.PI / 180)) *
							Math.sin(dLon / 2) * Math.sin(dLon / 2);
					const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
					return R * c;
			}
			
			// ËÆ°ÁÆó‰∏§‰∏™ÁªèÁ∫¨Â∫¶ÂùêÊ†á‰πãÈó¥ÁöÑ‰∏≠ÂøÉÁÇπ
			function calculateCenterPoint(lat1, lng1, lat2, lng2) {
			  // Â∞ÜËßíÂ∫¶ËΩ¨Êç¢‰∏∫ÂºßÂ∫¶
			  const toRadians = (degrees) => degrees * (Math.PI / 180);
			  // Â∞ÜÂºßÂ∫¶ËΩ¨Êç¢‰∏∫ËßíÂ∫¶
			  const toDegrees = (radians) => radians * (180 / Math.PI);
			  
			  const radLat1 = toRadians(lat1);
			  const radLat2 = toRadians(lat2);
			  const deltaLng = toRadians(lng2 - lng1);
			  
			  const bx = Math.cos(radLat2) * Math.cos(deltaLng);
			  const by = Math.cos(radLat2) * Math.sin(deltaLng);
			  
			  const centerLat = Math.atan2(
			    Math.sin(radLat1) + Math.sin(radLat2),
			    Math.sqrt((Math.cos(radLat1) + bx) * (Math.cos(radLat1) + bx) + by * by)
			  );
			  
			  const centerLng = toRadians(lng1) + Math.atan2(by, Math.cos(radLat1) + bx);
			  
			  return {
			    lat: toDegrees(centerLat),
			    lng: toDegrees(centerLng)
			  };
			}
			
		</script>
	</body>
</html>